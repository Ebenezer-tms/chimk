// Update your existing chatbot.db code to match your bot's structure
// Create this as `./lib/chatbotDB.js`:

const path = require('path');
const sqlite3 = require('sqlite3').verbose();

// Database path
const dbPath = path.join(__dirname, '..', 'Database', 'chatbot.db');

// Create Database directory if it doesn't exist
const fs = require('fs');
const dbDir = path.join(__dirname, '..', 'Database');
if (!fs.existsSync(dbDir)) {
    fs.mkdirSync(dbDir, { recursive: true });
}

// Initialize database
const dbe = new sqlite3.Database(dbPath, (err) => {
    if (err) {
        console.error("❌ Database Error:", err);
    } else {
        console.log("[BOT] Connected to Chatbot Database.");
        initializeDatabase();
    }
});

function initializeDatabase() {
    dbe.serialize(() => {
        // Create user_messages table
        dbe.run(`
            CREATE TABLE IF NOT EXISTS user_messages (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                userId TEXT NOT NULL,
                message TEXT NOT NULL,
                timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
            )
        `);
        
        // Create settings table
        dbe.run(`
            CREATE TABLE IF NOT EXISTS settings (
                key TEXT PRIMARY KEY,
                value TEXT
            )
        `);
        
        console.log("[BOT] Database tables initialized.");
    });
}

// Store user message
function storeUserMessage(userId, message) {
    const query = `INSERT INTO user_messages (userId, message) VALUES (?, ?)`;
    dbe.run(query, [userId, message], (err) => {
        if (err) console.error('❌ Error storing message:', err);
    });
}

// Get user messages
function getUserMessages(userId, limit = 25) {
    return new Promise((resolve, reject) => {
        const query = `
            SELECT message 
            FROM user_messages 
            WHERE userId = ? 
            ORDER BY timestamp DESC 
            LIMIT ?
        `;
        dbe.all(query, [userId, limit], (err, rows) => {
            if (err) {
                console.error('❌ Error retrieving messages:', err);
                reject(err);
            } else {
                const messages = rows.map(row => row.message).reverse();
                resolve(messages);
            }
        });
    });
}

// Cleanup old messages
function cleanupChatbotMessages(days = 7) {
    const query = `
        DELETE FROM user_messages 
        WHERE timestamp < datetime('now', ?)
    `;
    dbe.run(query, [`-${days} days`], (err) => {
        if (err) {
            console.error('❌ Error cleaning up old messages:', err);
        } else {
            console.log(`[BOT] Cleaned up messages older than ${days} days.`);
        }
    });
}

// Get setting
function getSetting(key) {
    return new Promise((resolve, reject) => {
        const query = `SELECT value FROM settings WHERE key = ?`;
        dbe.get(query, [key], (err, row) => {
            if (err) {
                reject(err);
            } else {
                resolve(row ? row.value : null);
            }
        });
    });
}

// Set setting
function setSetting(key, value) {
    const query = `INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)`;
    dbe.run(query, [key, value], (err) => {
        if (err) console.error('❌ Error saving setting:', err);
    });
}

// Auto-cleanup every 24 hours
setInterval(() => {
    cleanupChatbotMessages(7);
}, 24 * 60 * 60 * 1000);

// Initial cleanup
cleanupChatbotMessages(7);

module.exports = {
    storeUserMessage,
    getUserMessages,
    cleanupChatbotMessages,
    getSetting,
    setSetting,
    dbe
};
